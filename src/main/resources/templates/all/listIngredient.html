<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìœ ìŠ¤ë ˆì‹œí”¼</title>
    <link rel="stylesheet" href="../../static/css/templateBody.css" />
    <link rel="stylesheet" href="../../static/css/store.css" />
    <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/footer.css" />
    <link rel="stylesheet" type="text/css" href="../../static/css/header.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
        $(document).ready(function() {


            //ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆ ì €ì¥ëœ ì‹í’ˆë“¤ì€ ë‹´ê¸°ë²„íŠ¼ì— ìƒ‰ìƒí‘œí˜„.
            $('.ingreId').each(function() {
                var $this = $(this); // í˜„ì¬ ìš”ì†Œë¥¼ $thisì— ì €ì¥
                var id= parseFloat($(this).text());  // í˜„ì¬ ìš”ì†Œì˜ í…ìŠ¤íŠ¸ë¥¼ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜\
                console.log(id);
                $.ajax({
                    url: '/checkCart',
                    type: 'POST',
                    data: { Id: id },
                    success: function(response) {
                        // ìš”ì²­ì´ ì„±ê³µí–ˆì„ ë•Œ ì‹¤í–‰ë  í•¨ìˆ˜
                        console.log('ì„œë²„ ì‘ë‹µ:', response);
                        if(response ==='ì €ì¥ë¨') {
                            //ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¨ìˆë‹¤ë©´ ë‚˜íƒ€ë‚¼ UI
                            var $btn = $this.closest('.storeItem').find('.cartBtn');
                            $btn.css('backgroundColor','#D65454');
                            $btn.find("span").css('color','#fff');
                            $btn.find('.cart').attr('stroke', '#fff');
                            $btn.find('.cart').attr('saved',"true");

                            console.log("ì €ì¥í™•ì¸ë˜ì–´ ë²„íŠ¼ìƒ‰ìƒë³€ê²½")
                        } else {
                            console.log("ì €ì¥ë˜ì§€ ì•Šì€ ì•„ì´í…œ")
                        }
                    },
                    error: function (xhr, status, error) {
                        // ìš”ì²­ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰ë  í•¨ìˆ˜
                        console.error('ì—ëŸ¬ ë°œìƒ:', error);
                    }
                });
            })



            // ë‹´ê¸° í´ë¦­ì‹œ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€í•˜ê¸°
            $('.cartBtn').click(function() {
                var $this = $(this);
                var storeItemElement = $(this).closest('.storeItem');
                var ingredientId = storeItemElement.find('.ingreId').text();
                console.log("ìƒí’ˆ ID: ", ingredientId);
                //  ìƒí’ˆ idë¥¼ ì „ë‹¬ í›„ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ìš”ì²­
                $.ajax({
                    url: '/addCart', // ìš”ì²­ì„ ë³´ë‚¼ ì„œë²„ì˜ URL
                    type: 'POST', // HTTP ìš”ì²­ ë°©ì‹
                    data: { Id: ingredientId }, // ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„°
                    success: function(response) {
                        // ìš”ì²­ì´ ì„±ê³µí–ˆì„ ë•Œ ì‹¤í–‰ë  í•¨ìˆ˜
                        console.log('ì„œë²„ ì‘ë‹µ:', response);

                        if(response ==='ì €ì¥í•¨'){
                            //ë‹´ê¸°ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½
                            $this.css('backgroundColor','#D65454');
                            $this.find('span').css('color','#fff');
                            $this.find('.cart').attr('stroke', '#fff');
                            $this.find('.cart').attr('saved',"true");
                            //"ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì„ ë‹´ì•˜ìŠµë‹ˆë‹¤" ì¶œë ¥
                            $('#modalbox1').css('display', 'block');

                        }else {
                            //"ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¨ìˆëŠ” ìƒí’ˆì…ë‹ˆë‹¤" ì¶œë ¥
                            $('#modalbox3').css('display', 'block');
                        }
                    },
                    error: function(xhr, status, error) {
                        // ìš”ì²­ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰ë  í•¨ìˆ˜
                        console.error('ì—ëŸ¬ ë°œìƒ:', error);
                        $('#modalbox2').css('display', 'block');
                    }
                });

            });





            // ë‹´ê¸° ë²„íŠ¼ í´ë¦­ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ëª¨ë‹¬ì°½ ë‹«ê¸°
            $('#btnClose').click(()=>{
                $('#modalbox1').css('display','none');
            })
            $('#btnClose2').click(()=>{
                $('#modalbox2').css('display','none');
            })
            $('#btnClose3').click(()=>{
                $('#modalbox3').css('display','none');
            })

            $('#btnToCart').click(()=>{
                window.location.href = "/cart";
            })


            // ìµœê·¼ ë³¸ ìƒí’ˆì˜ ë°ì´í„° ì €ì¥.
            $('.toDetail').click(function (){
                var href =    $(this).attr('href');
                var src = $(this).find('img').attr('src');

                let previousData =localStorage.getItem('items');

                let items = previousData? JSON.parse(previousData) :[];
                var ch = true;
                for (let i = 0; i < items.length; i++) {
                    if (items[i]["HREF"] === href) {
                        ch = false;
                    }
                }

                if (items.length === 0 || ch) {
                    items.push({
                        HREF :href,
                        SRC  :src
                    });
                }

                if(items.length > 5){
                    items.shift();
                }

                let data = JSON.stringify(items);
                localStorage.setItem('items', data);
            })



            function loadRecentlyViewed() {
                let previousData =localStorage.getItem('items');
                //ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ nullì´ë©´ ë¹ˆë°°ì—´ì„ ë„£ê³ , ë°ì´í„°ê°€ ìˆë‹¤ë©´ íŒŒì‹±í•œë‹¤.
                //let items = previousData? JSON.parse(previousData) :[];
                let items;
                if(previousData == null){
                    items= [];
                }else {
                    items = JSON.parse(previousData);
                    // ìì£¼ë³¸ ìƒí’ˆ ui ë³´ì´ë„ë¡ ì„¤ì •
                    $('#RecentlyViewedContainer').css('display','block');
                }


                items.map(function (item,index){
                    var itemHref=item.HREF;
                    var itemSrc=item.SRC;
                    var a = $("<a></a>").attr('href',itemHref);
                    var img = $("<img/>").attr('src',itemSrc);
                    img.addClass('imgSize');
                    a.append(img);
                    $('.RecentlyViewedBox').prepend(a); // ìµœì‹ ìš”ì†Œë¥¼ ê³„ì† í•´ì„œ ìœ„ìª½ì— ë°°ì¹˜ì‹œí‚´
                })
            }


            $('#scrollUp').click(function() {
                // í˜„ì¬ .RecentlyViewedBoxì˜ top ìœ„ì¹˜ë¥¼ ê°€ì£ ì˜´
                let currentTop = parseInt($('.RecentlyViewedBox').css('top'), 10);
                console.log('currenttop:'+currentTop);
                if(currentTop  < 0 ){
                    // top ìœ„ì¹˜ë¥¼ +20pxë§Œí¼  ì´ë™ì‹œí‚´
                    $('.RecentlyViewedBox').css('top', (currentTop + 20) + 'px');
                }
            });




            $('#scrollDown').click(function() {
                var viewBoxHeight =  parseInt($('.RecentlyViewedBox').css('height'), 10);

                console.log("h1"+viewBoxHeight)
                var viewport =  parseInt($('.viewport').css('height'), 10);
                console.log("h2"+viewport)
                var boundary = Math.abs(viewBoxHeight -viewport);
                console.log("h3"+boundary)


                // í˜„ì¬ .RecentlyViewedBoxì˜ top ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜´
                let currentTop = parseInt($('.RecentlyViewedBox').css('top'), 10);
                // top ìœ„ì¹˜ë¥¼ -20pxë§Œí¼ ì´ë™
                if(currentTop > -boundary){
                    $('.RecentlyViewedBox').css('top', (currentTop - 20) + 'px');
                }
            });

            loadRecentlyViewed();


            // ì¥ë°”êµ¬ë‹ˆ icon í˜¸ë²„ì´ë²¤íŠ¸
            $(".cartBtn").on("mouseenter",function(){
                $(this).find(".cart").attr('stroke', '#fff');
            })
            $(".cartBtn").on("mouseleave",function(){
                $(this).find(".cart[saved='false']").attr('stroke', '#333');
            })

        // ìµœê·¼ì— ë³¸ ìƒí’ˆ ìŠ¤í¬ë¡¤ ì‹œ ìœ„ì¹˜ ì¡°ì •
        var $fixed = $('#RecentlyViewedContainer');
        var stopPosition = 1000; // ê³ ì •ì„ í•´ì œí•  ìŠ¤í¬ë¡¤ ìœ„ì¹˜ (í”½ì…€ ë‹¨ìœ„)

        $(window).on('scroll', function() {
            if ($(this).scrollTop() > stopPosition) {
                console.log("ë„ë‹¬í•¨")
                $fixed.css({
                    'position': 'absolute',
                    'top': stopPosition + 'px'
                });
            } else {
                $fixed.css({
                    'position': 'fixed',
                    'top': '30%'
                });
            }
        });
    });
</script>


</head>
<body >
<div class="templateBody">
    <header>
        <div class="header" th:replace="header :: header"></div>
    </header>
    <div class="mainBody">
        <div class="storeContainer1">
            <h2>ì¬ë£Œ ìŠ¤í† ì–´</h2>
            <div class="Container1_box">
                <ul class="Container1_boxul">
                    <li><a th:href="@{/listIngredient/{i}(i=1, category='000')}">ì „ì²´ë³´ê¸°</a></li>
                    <li><a th:href="@{/listIngredient/{i}(i=1, category='1')}">ì†Œê³ ê¸°</a></li>
                    <li><a th:href="@{/listIngredient/{i}(i=1, category='2')}">ë¼ì§€ê³ ê¸°</a></li>
                    <li><a th:href="@{/listIngredient/{i}(i=1, category='3')}">ë‹­ê³ ê¸°</a></li>
                    <li><a th:href="@{/listIngredient/{i}(i=1, category='4')}">ì±„ì†Œ</a></li>
                    <li><a th:href="@{/listIngredient/{i}(i=1, category='5')}">ê³¼ì¼</a></li>
                    <li>ì¹´í…Œê³ ë¦¬1</li>
                    <li>ì¹´í…Œê³ ë¦¬2</li>
                    <li>ì¹´í…Œê³ ë¦¬3</li>
                </ul>
            </div>

            <div class="Container1_box2">
                <ul class="Container1_box2ul">
                    <li><a th:href="@{/listIngredient/{i}(i=1, sortBy='id', direction='DESC')}">ìµœì‹ ìˆœ</a></li>
                    <li><a th:href="@{/listIngredient/{i}(i=1, sortBy='id',direction='ASC')}">ì˜¤ë˜ëœìˆœ</a></li>
                    <li><a th:href="@{/listIngredient/{i}(i=1, sortBy='ingredientPrice', direction='DESC')}">ê°€ê²©ë†’ì€ìˆœ</a></li>
                    <li><a th:href="@{/listIngredient/{i}(i=1, sortBy='ingredientPrice',direction='ASC')}">ê°€ê²©ë‚®ì€ìˆœ</a></li>
                </ul>
            </div>
        </div>

        <div class="storeContainer2">
            <div class="storeContainer2GirdBox">

                <div class="storeItem" th:each=" i : ${list}">
                    <a th:href="@{/detailIngredient(ingredientId=${i.id})}" class="toDetail">
                        <img th:attr="src=@{'../../static/ingredientImages/' + ${i.ingredientImage}}"
                             class="storeItem_img"
                             onerror="this.onerror=null; this.src='../static/images/ingredients/img_none.png'">
                    </a>
                    <button class="cartBtn">
                        <!-- <img class="cartIcon" src="../../static/images/icon/ì¹´íŠ¸.svg"/> -->
                        <svg width="22" height="22" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                            <g fill="none" fill-rule="evenodd">
                                <path d="M36 36H0V0h36z"/>
                                <g class="cart" saved="false" transform="translate(5.164 6.547)" stroke="#333" stroke-linecap="square" stroke-linejoin="round" stroke-width="1.7">
                                    <path d="m25.68 3.66-2.72 11.57H7.37L4.66 3.66z"/>
                                    <circle cx="20.52" cy="20.78" r="2.14"/>
                                    <circle cx="9.81" cy="20.78" r="2.14"/>
                                    <path d="M0 0h3.8l1.76 7.5"/>
                                </g>
                            </g>
                        </svg>
                        <span>ë‹´ê¸°</span>
                    </button>
                    <div class="storeItem_info">
                        <a th:href="@{/detailIngredient(ingredientId=${i.id})}"><p th:text="${i.ingredientName}">ìƒí’ˆëª…</p></a>
                        <p th:text="${i.ingredientPrice}+'ì›'">ìƒí’ˆê°€ê²©</p>
                        <P th:text="${i.id}" class="ingreId">ì¬ë£Œid</P><!--ì¥ë°”êµ¬ë‹ˆë‹´ê¸° ì „ì†¡í•  i.id-->
                    </div>
                </div>

            </div>
            <div class="pageBox">
                <th:block th:each="i:${#numbers.sequence(1,totalPage)}">
                    <a class="pageNum" th:href="@{|/listIngredient/${i}|}" th:text="${i}"></a> <!--URIë°©ì‹ì„  -->
                </th:block>

            </div>
        </div>
        <div class="modelContainer">
            <div class="modalbox1" id="modalbox1">
                <h3>ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì„ ë‹´ì•˜ìŠµë‹ˆë‹¤.</h3>
                <button class="btnModal" id="btnToCart">ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™</button>
                <button class="btnModal" id="btnClose">í™•ì¸</button>
            </div>
            <div class="modalbox2" id="modalbox2" >
                <h3>ë¡œê·¸ì¸ì‹œ ì´ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤ğŸ™</h3>
                <button class="btnModal" id="btnClose2">í™•ì¸</button>
            </div>
            <div class="modalbox3" id="modalbox3" >
                <h3>ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¨ìˆëŠ” ìƒí’ˆì…ë‹ˆë‹¤.</h3>
                <button class="btnModal" id="btnClose3">í™•ì¸</button>
            </div>

        </div>

        <!-- ìµœê·¼ ë³¸ ìƒí’ˆ-->
        <div id="RecentlyViewedContainer">
            <img id="scrollUp"  src="../../static/images/icon/upArrow.png"/>
            <div><h4>ìµœê·¼ ë³¸ ìƒí’ˆ</h4></div>
            <div id="recentlyViewedItems" class="viewport">
                <div class="RecentlyViewedBox">
                    <!-- ìµœê·¼ ë³¸ ìƒí’ˆ ëª©ë¡ ì˜ì—­-->
                </div>
            </div>
            <img id="scrollDown"  src="../../static/images/icon/downArrow.png"/>
        </div>


    </div>
    <div class="footer" th:replace="footer :: footer"></div>

</div>
</body>
</html>